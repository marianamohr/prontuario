import{e as w,r,a0 as q,j as e,T as h,B as R,V as l,P as B}from"./index-DJlnvih6.js";import{P as A}from"./PageContainer-DrcGApUY.js";import{T as F}from"./TextField-CttgYVuf.js";import{F as k,I as z,S as E}from"./Select-cu5oWY5i.js";import{B as I}from"./Button-6qkZ5rwi.js";import{A as P}from"./Alert-CVqmUb3o.js";import{T as L,a as O,b as W,c as m,d as a,e as $}from"./TableRow-Bh5fPPOD.js";import{C as u}from"./Chip-D7mbk4PO.js";function K(){const[T]=w(),n=T.get("request_id")||"",[i,p]=r.useState([]),[o,j]=r.useState(!1),[f,v]=r.useState(""),[g,b]=r.useState(0),[c,S]=r.useState(n),[d,C]=r.useState("");r.useEffect(()=>{S(n),n&&(b(0),p([]))},[n]);const _=r.useMemo(()=>i.length>0&&!o,[i.length,o]),x=r.useCallback(s=>{j(!0),v("");const y=s?0:g;q({limit:50,offset:y,request_id:c.trim()||void 0,severity:d||void 0}).then(t=>{p(s?t.items:[...i,...t.items]),b(y+t.items.length)}).catch(t=>v((t==null?void 0:t.message)||"Falha ao carregar auditoria.")).finally(()=>j(!1))},[g,c,d,i]);return r.useEffect(()=>{x(!0)},[]),e.jsxs(A,{children:[e.jsx(h,{variant:"h4",sx:{mb:1.5},children:"Auditoria"}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Linha do tempo unificada (eventos + acessos). Sem PII; use o Request ID para correlacionar com erros."}),e.jsxs(R,{sx:{display:"flex",gap:1,flexWrap:"wrap",mb:2},children:[e.jsx(F,{label:"Request ID (opcional)",value:c,onChange:s=>S(s.target.value),size:"small",sx:{minWidth:280}}),e.jsxs(k,{size:"small",sx:{minWidth:180},children:[e.jsx(z,{children:"Severidade"}),e.jsxs(E,{value:d,label:"Severidade",onChange:s=>C(String(s.target.value)),children:[e.jsx(l,{value:"",children:"Todas"}),e.jsx(l,{value:"INFO",children:"INFO"}),e.jsx(l,{value:"WARN",children:"WARN"}),e.jsx(l,{value:"ERROR",children:"ERROR"})]})]}),e.jsx(I,{variant:"contained",onClick:()=>x(!0),disabled:o,children:o?"Carregando...":"Buscar"}),e.jsx(I,{variant:"outlined",onClick:()=>x(!1),disabled:!_,children:"Carregar mais"})]}),f&&e.jsx(P,{severity:"error",sx:{mb:2},children:f}),e.jsx(L,{component:B,variant:"outlined",children:e.jsxs(O,{size:"small",children:[e.jsx(W,{children:e.jsxs(m,{children:[e.jsx(a,{children:"Data/hora"}),e.jsx(a,{children:"Tipo"}),e.jsx(a,{children:"Ação"}),e.jsx(a,{children:"Ator"}),e.jsx(a,{children:"Recurso"}),e.jsx(a,{children:"Request"})]})}),e.jsxs($,{children:[i.map(s=>e.jsxs(m,{hover:!0,children:[e.jsx(a,{sx:{whiteSpace:"nowrap"},children:new Date(s.created_at).toLocaleString("pt-BR")}),e.jsx(a,{children:e.jsx(u,{size:"small",label:s.kind})}),e.jsx(a,{children:e.jsxs(R,{sx:{display:"flex",gap:.5,flexWrap:"wrap",alignItems:"center"},children:[e.jsx(u,{size:"small",label:s.severity}),s.is_impersonated&&e.jsx(u,{size:"small",color:"warning",label:"impersonate"}),e.jsx("span",{children:s.action})]})}),e.jsxs(a,{sx:{whiteSpace:"nowrap"},children:[s.actor_type,s.actor_id?`/${s.actor_id}`:""]}),e.jsx(a,{sx:{whiteSpace:"nowrap"},children:s.resource_type?`${s.resource_type}${s.resource_id?`/${s.resource_id}`:""}`:"—"}),e.jsx(a,{sx:{fontFamily:"monospace",fontSize:12},children:s.request_id||"—"})]},`${s.kind}-${s.id}`)),i.length===0&&e.jsx(m,{children:e.jsx(a,{colSpan:6,children:e.jsx(h,{color:"text.secondary",children:"Nenhum item encontrado."})})})]})]})})]})}export{K as BackofficeAudit};
