import{M as Oe,a6 as We,u as Me,a as Ge,r as o,Y as $e,ab as w,j as t,B as p,T as i,L as fe,P as ve,I as ge,V as R,ac as Ve,ad as Be,ae as Ue,af as Xe,ag as qe,ah as Qe,ai as Ye}from"./index-DJlnvih6.js";import{h as He}from"./html2pdf-CQmOXuT7.js";import{D as Ce}from"./DeleteOutline-CllXSIWN.js";import{P as Je}from"./PageContainer-DrcGApUY.js";import{A as je}from"./AppDialog-C8ethuMW.js";import{A as _}from"./Alert-CVqmUb3o.js";import{B as c}from"./Button-6qkZ5rwi.js";import{F as U,I as ye,S as X}from"./Select-cu5oWY5i.js";import{T as v}from"./TextField-CttgYVuf.js";function lt(){var he;const be=Oe(),{patientId:r}=We(),{user:u,isImpersonated:Se}=Me(),F=((he=Ge())==null?void 0:he.branding)??null,m=(u==null?void 0:u.role)==="PROFESSIONAL"&&(F!=null&&F.action_button_color)?F.action_button_color:be.palette.primary.main,g=(u==null?void 0:u.role)==="PROFESSIONAL"||(u==null?void 0:u.role)==="SUPER_ADMIN",[C,q]=o.useState([]),[I,Q]=o.useState(!0),[Y,A]=o.useState(""),[Ie,N]=o.useState(!1),[De,H]=o.useState([]),[x,J]=o.useState(""),[f,L]=o.useState(""),[T,K]=o.useState(""),[O,Z]=o.useState(""),[D,ee]=o.useState(""),[W,te]=o.useState(""),[ae,ne]=o.useState(!1),[oe,j]=o.useState(!1),[h,n]=o.useState(""),[y,b]=o.useState([]),[re,se]=o.useState(null),[le,ie]=o.useState(null),[Pe,ce]=o.useState(null),[M,P]=o.useState([]),[E,de]=o.useState(""),[G,k]=o.useState(null),[z,$]=o.useState(""),[me,Ee]=o.useState(!1),V=5,B=o.useCallback(()=>{r&&(A(""),Q(!0),$e(r).then(e=>q(e.guardians)).catch(()=>{q([]),A("Falha ao carregar responsáveis.")}).finally(()=>Q(!1)),g&&w(r).then(e=>b(e.contracts)).catch(()=>{b([]),A("Falha ao carregar contratos.")}))},[r,g]);o.useEffect(()=>{B()},[B]);const we=()=>{var e;N(!0),n(""),J(((e=C[0])==null?void 0:e.id)??""),L(""),K(""),Z(""),ee(""),te(""),P([]),de(""),Ve().then(a=>{H(a.templates),a.templates.length>0&&L(a.templates[0].id)}).catch(()=>H([]))},ue=e=>{const a=e.replace(/\s/g,"").replace(/[R$\s]/gi,"").replace(",","."),s=parseFloat(a);return Number.isNaN(s)||s<0?"":`valor de R$ ${s.toFixed(2).replace(".",",")} por sessão`},_e=async()=>{if(!r||!x||!f)return;const e=D.trim();if(!e){n("Informe o valor por sessão.");return}const a=ue(e);if(!a){n("Informe um valor numérico válido (ex.: 150 ou 150,50).");return}ne(!0),n("");try{await Qe(r,x,f,T||void 0,O||void 0,a,W.trim()||void 0,M.length>0?M:void 0,void 0,void 0,E!==""&&Number(E)>0?Number(E):void 0),n("Contrato enviado por e-mail para assinatura."),w(r).then(s=>b(s.contracts)).catch(()=>{}),setTimeout(()=>N(!1),1500)}catch{n("Falha ao enviar contrato.")}finally{ne(!1)}},Fe=async e=>{if(r){se(e),n("");try{await Ue(r,e),n("Contrato reenviado por e-mail."),w(r).then(a=>b(a.contracts))}catch{n("Falha ao reenviar contrato.")}finally{se(null)}}},Ne=async()=>{if(!(!r||!G||!z)){n("");try{await Ye(r,G,z),n("Contrato encerrado. Agendamentos a partir da data foram finalizados."),k(null),$(""),w(r).then(e=>b(e.contracts))}catch(e){let a="Falha ao encerrar contrato.";if(e instanceof Error&&e.message)try{const s=JSON.parse(e.message);s!=null&&s.error&&(a=s.error)}catch{e.message.length<120&&(a=e.message)}n(a)}}},ke=async e=>{if(r&&window.confirm("Cancelar este contrato? O contrato será tornado ineligível e os agendamentos vinculados serão cancelados. O responsável será notificado por e-mail.")){ie(e),n("");try{const a=await Xe(r,e);n(a.message??"Contrato cancelado. O responsável foi notificado por e-mail."),w(r).then(s=>b(s.contracts))}catch{n("Falha ao cancelar contrato.")}finally{ie(null)}}},ze=async e=>{if(!(!r||!window.confirm("Tem certeza que deseja excluir (soft delete) este contrato? Ele vai sumir do front para profissionais."))){ce(e);try{await Be(r,e),n("Contrato excluído."),B()}catch{n("Falha ao excluir contrato.")}finally{ce(null)}}},Re=()=>{if(!r||!x||!f)return;const e=D.trim(),a=e?ue(e):void 0;if(e&&!a){n("Informe um valor numérico válido para o preview.");return}n(""),j(!0),qe(r,x,f,T||void 0,O||void 0,a,W.trim()||void 0).then(({body_html:s})=>{const l=document.createElement("iframe");l.setAttribute("style","position:absolute;width:210mm;height:297mm;left:-9999px;top:0;border:none;"),document.body.appendChild(l);const d=l.contentDocument;if(!d){j(!1),document.body.removeChild(l),n("Não foi possível gerar o preview.");return}d.open(),d.write(s),d.close(),l.onload=()=>{setTimeout(()=>{var pe;const S=(pe=l.contentDocument)==null?void 0:pe.body;if(!S){j(!1),document.body.removeChild(l);return}const Le={margin:10,filename:"preview-contrato.pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};He().set(Le).from(S).outputPdf("blob").then(Te=>{const xe=URL.createObjectURL(Te);window.open(xe,"_blank","noopener,noreferrer"),URL.revokeObjectURL(xe),document.body.removeChild(l),j(!1)},()=>{document.body.contains(l)&&document.body.removeChild(l),j(!1)})},100)}}).catch(()=>{j(!1),n("Falha ao carregar preview.")})};if(!r)return null;const Ae=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];return t.jsxs(Je,{children:[t.jsxs(p,{sx:{display:"flex",flexWrap:"wrap",gap:.5,alignItems:"center",mb:2},children:[t.jsx(i,{component:fe,to:"/patients",sx:{color:"primary.main",textDecoration:"none"},children:"← Pacientes"}),t.jsx(i,{component:"span",color:"text.secondary",children:"·"}),t.jsx(i,{component:fe,to:`/patients/${r}/prontuario`,sx:{color:"primary.main",textDecoration:"none"},children:"Prontuário"})]}),t.jsx(i,{variant:"h4",sx:{mb:2},children:"Contratos do paciente"}),!I&&C.length>0&&t.jsxs(_,{severity:"info",sx:{mb:2},children:[t.jsx("strong",{children:"Responsável(is) legal(is):"})," ",C.map(e=>`${e.full_name}${e.relation?` (${e.relation})`:""}`).join("; ")]}),I&&t.jsx(i,{color:"text.secondary",children:"Carregando..."}),Y&&t.jsx(_,{severity:"error",sx:{mb:2},children:Y}),g&&!I&&C.length>0&&t.jsx(p,{sx:{mb:2},children:t.jsx(c,{variant:"contained",onClick:we,sx:{bgcolor:m,"&:hover":{bgcolor:m,opacity:.9}},children:"Disparar contrato para assinar"})}),g&&y.length>0&&t.jsxs(ve,{variant:"outlined",sx:{p:2,mb:2,bgcolor:"grey.50"},children:[t.jsx(i,{variant:"subtitle1",fontWeight:600,sx:{mb:1.5},children:"Contratos enviados"}),t.jsx(p,{component:"ul",sx:{listStyle:"none",p:0,m:0},children:(me?y:y.slice(0,V)).map(e=>t.jsxs(ve,{variant:"outlined",sx:{p:1.5,mb:.75,display:"flex",flexWrap:"wrap",alignItems:"center",gap:.5,justifyContent:"space-between"},children:[t.jsxs(p,{sx:{flex:"1 1 200px"},children:[t.jsxs(i,{fontWeight:600,children:[e.template_name," — ",e.guardian_name]}),t.jsx(i,{variant:"body2",color:"text.secondary",sx:{mt:.25},children:e.status==="CANCELLED"?t.jsx(i,{component:"span",color:"text.secondary",children:"Contrato cancelado"}):e.status==="ENDED"?t.jsx(i,{component:"span",color:"text.secondary",children:"Contrato encerrado"}):e.status==="SIGNED"?t.jsxs(i,{component:"span",color:"success.main",children:["Assinado",e.signed_at?` em ${new Date(e.signed_at).toLocaleDateString("pt-BR")}`:""]}):t.jsx(i,{component:"span",color:"warning.main",children:"Pendente de assinatura"})})]}),t.jsxs(p,{sx:{display:"flex",gap:.5,flexShrink:0,flexWrap:"wrap",alignItems:"center"},children:[Se&&t.jsx(ge,{size:"small",title:"Excluir contrato","aria-label":"Excluir contrato",color:"error",disabled:Pe===e.id,onClick:()=>ze(e.id),children:t.jsx(Ce,{fontSize:"small"})}),e.status==="CANCELLED"?t.jsx(i,{variant:"body2",color:"text.secondary",children:"Contrato cancelado"}):e.status==="ENDED"?e.verify_url?t.jsx(c,{size:"small",variant:"contained",href:e.verify_url,target:"_blank",rel:"noopener noreferrer",sx:{bgcolor:m,"&:hover":{bgcolor:m,opacity:.9}},children:"Ver contrato assinado"}):null:t.jsxs(t.Fragment,{children:[e.status==="PENDING"&&t.jsx(c,{size:"small",variant:"outlined",color:"warning",disabled:re===e.id,onClick:()=>Fe(e.id),children:re===e.id?"Reenviando...":"Reenviar"}),e.status==="SIGNED"&&e.verify_url&&t.jsx(c,{size:"small",variant:"contained",href:e.verify_url,target:"_blank",rel:"noopener noreferrer",sx:{bgcolor:m,"&:hover":{bgcolor:m,opacity:.9}},children:"Ver contrato assinado"}),e.status==="SIGNED"&&t.jsx(c,{size:"small",variant:"outlined",onClick:()=>{k(e.id),$(""),n("")},children:"Encerrar contrato"}),(e.status==="PENDING"||e.status==="SIGNED")&&t.jsx(c,{size:"small",variant:"outlined",color:"error",disabled:le===e.id,onClick:()=>ke(e.id),children:le===e.id?"Cancelando...":"Cancelar"})]})]})]},e.id))}),y.length>V&&t.jsx(c,{size:"small",onClick:()=>Ee(e=>!e),sx:{mt:1},children:me?"Ver menos":`Ver mais (${y.length-V} restantes)`}),h&&y.length>0&&t.jsx(_,{severity:h.includes("Falha")?"error":"success",sx:{mt:.5,fontSize:14},children:h})]}),!I&&g&&C.length===0&&t.jsx(i,{color:"text.secondary",children:"Nenhum responsável com e-mail cadastrado. Cadastre um responsável com e-mail para enviar contratos."}),!I&&!g&&t.jsx(i,{color:"text.secondary",children:"Apenas profissionais podem gerenciar contratos."}),t.jsxs(je,{open:Ie,onClose:()=>N(!1),title:"Enviar contrato para assinatura",maxWidth:"md",actions:t.jsxs(t.Fragment,{children:[t.jsx(c,{variant:"outlined",onClick:Re,disabled:oe||!x||!f||!D.trim(),children:oe?"Gerando PDF...":"Preview em PDF"}),t.jsx(c,{onClick:()=>N(!1),color:"inherit",children:"Fechar"}),t.jsx(c,{variant:"contained",onClick:_e,disabled:ae||!x||!f||!D.trim(),sx:{bgcolor:m,"&:hover":{bgcolor:m,opacity:.9}},children:ae?"Enviando...":"Enviar por e-mail"})]}),children:[t.jsxs(p,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},gap:2,maxHeight:"60vh",overflow:"auto"},children:[t.jsxs(p,{sx:{display:"flex",flexDirection:"column",gap:1},children:[t.jsxs(U,{fullWidth:!0,size:"small",children:[t.jsx(ye,{children:"Responsável"}),t.jsx(X,{value:x,label:"Responsável",onChange:e=>J(e.target.value),children:C.map(e=>t.jsxs(R,{value:e.id,children:[e.full_name," – ",e.email]},e.id))})]}),t.jsxs(U,{fullWidth:!0,size:"small",children:[t.jsx(ye,{children:"Modelo de contrato"}),t.jsxs(X,{value:f,label:"Modelo de contrato",onChange:e=>L(e.target.value),children:[t.jsx(R,{value:"",children:"Selecione..."}),De.map(e=>t.jsx(R,{value:e.id,children:e.name},e.id))]})]}),t.jsx(v,{type:"date",label:"Data de início",size:"small",fullWidth:!0,value:T,onChange:e=>K(e.target.value),InputLabelProps:{shrink:!0}}),t.jsx(v,{type:"date",label:"Data de término",size:"small",fullWidth:!0,value:O,onChange:e=>Z(e.target.value),InputLabelProps:{shrink:!0}}),t.jsx(v,{label:"Valor por sessão (R$) *",size:"small",fullWidth:!0,value:D,onChange:e=>{ee(e.target.value),n("")},placeholder:"Ex.: 150 ou 150,50"}),t.jsx(i,{variant:"caption",color:"text.secondary",children:'Exibido no contrato como "valor de R$ XX,XX por sessão"'}),t.jsx(v,{label:"Periodicidade (opcional)",size:"small",fullWidth:!0,value:W,onChange:e=>te(e.target.value),placeholder:"Ex.: semanal, quinzenal, mensal"})]}),t.jsxs(p,{sx:{display:"flex",flexDirection:"column",gap:1},children:[t.jsx(v,{type:"number",label:"Quantidade de agendamentos (opcional)",size:"small",fullWidth:!0,value:E===""?"":E,onChange:e=>{const a=e.target.value;de(a===""?"":Math.max(1,parseInt(a,10)||1))},placeholder:"Ex.: 4",inputProps:{min:1}}),t.jsx(i,{variant:"caption",color:"text.secondary",children:"Pré-agendar consultas (opcional)"}),M.map((e,a)=>t.jsxs(p,{sx:{display:"flex",gap:.5,alignItems:"center"},children:[t.jsx(U,{size:"small",sx:{minWidth:100},children:t.jsx(X,{value:e.day_of_week,onChange:s=>P(l=>l.map((d,S)=>S===a?{...d,day_of_week:Number(s.target.value)}:d)),children:Ae.map((s,l)=>t.jsx(R,{value:l,children:s},l))})}),t.jsx(v,{type:"time",size:"small",value:e.slot_time,onChange:s=>P(l=>l.map((d,S)=>S===a?{...d,slot_time:s.target.value}:d)),sx:{width:110},InputLabelProps:{shrink:!0}}),t.jsx(ge,{size:"small",color:"error",onClick:()=>P(s=>s.filter((l,d)=>d!==a)),"aria-label":"Remover",children:t.jsx(Ce,{fontSize:"small"})})]},a)),t.jsx(c,{size:"small",variant:"outlined",onClick:()=>P(e=>[...e,{day_of_week:1,slot_time:"09:00"}]),children:"+ Adicionar horário"})]})]}),h&&t.jsx(_,{severity:h.includes("Falha")?"error":"success",sx:{mt:1},children:h})]}),t.jsxs(je,{open:!!G,onClose:()=>{k(null),n("")},title:"Encerrar contrato",actions:t.jsxs(t.Fragment,{children:[t.jsx(c,{onClick:()=>{k(null),n("")},color:"inherit",children:"Cancelar"}),t.jsx(c,{variant:"contained",onClick:Ne,disabled:!z,sx:{bgcolor:m,"&:hover":{bgcolor:m,opacity:.9}},children:"Confirmar encerramento"})]}),children:[t.jsx(i,{variant:"body2",color:"text.secondary",sx:{mb:1.5},children:"Informe a data de término. Os agendamentos a partir dessa data serão finalizados na agenda."}),t.jsx(v,{type:"date",label:"Data de término",fullWidth:!0,value:z,onChange:e=>$(e.target.value),InputLabelProps:{shrink:!0},sx:{mb:1}}),h&&t.jsx(_,{severity:h.includes("Falha")?"error":"success",sx:{mb:1},children:h})]})]})}export{lt as PatientContracts};
