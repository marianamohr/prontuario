import{M as Ne,u as Fe,a as Oe,r,b as We,aW as $e,j as e,N as Be,T as c,B as i,I as B,aX as He,aY as Ye,P as de,aZ as H,V as A,a_ as pe,a$ as Ue}from"./index-DJlnvih6.js";import{D as Qe}from"./DeleteOutline-CllXSIWN.js";import{P as me}from"./PageContainer-DrcGApUY.js";import{A as ue}from"./AppDialog-C8ethuMW.js";import{B as d}from"./Button-6qkZ5rwi.js";import{T as I}from"./TextField-CttgYVuf.js";import{F as he,I as xe,S as ge}from"./Select-cu5oWY5i.js";const Ve=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"],Y=7,Xe=20,h=52;function Ce(s){return new Date(s+"T12:00:00").toLocaleDateString("pt-BR")}function fe(s){const o=new Date(s),l=o.getDay(),C=l===0?-6:1-l;return o.setDate(o.getDate()+C),o}function j(s){return s.toISOString().slice(0,10)}function M(s,o){const l=new Date(s);return l.setDate(l.getDate()+o),l}function be(s){const[o,l]=s.split(":").map(Number);return(o??0)*60+(l??0)}function at(){var le;const s=Ne(),{user:o,isImpersonated:l}=Fe(),C=((le=Oe())==null?void 0:le.branding)??null,m=(o==null?void 0:o.role)==="PROFESSIONAL"&&(C!=null&&C.action_button_color)?C.action_button_color:s.palette.primary.main,[je,U]=r.useState([]),[ve,Q]=r.useState(!0),[f,T]=r.useState(()=>j(fe(new Date))),[x,k]=r.useState(null),[V,X]=r.useState(""),[Z,q]=r.useState(""),[L,G]=r.useState(""),[w,J]=r.useState(null),[z,b]=r.useState(""),[N,P]=r.useState(!1),[R,K]=r.useState([]),[v,F]=r.useState(""),[ee,y]=r.useState([{appointment_date:"",start_time:"09:00"}]),[te,ae]=r.useState(!1),[O,S]=r.useState(""),[ye,D]=r.useState(null),ne=f,W=j(M(new Date(f+"T12:00:00"),6)),E=r.useCallback(()=>{We(ne,W).then(t=>U(t.appointments||[])).catch(()=>U([])).finally(()=>Q(!1))},[ne,W]);r.useEffect(()=>{Q(!0),E()},[E]);const oe=t=>{k(t.id),X(t.appointment_date),q(t.start_time),G(t.status),D(null)},Se=async()=>{if(x){b("");try{await pe(x,{appointment_date:V,start_time:Z,status:L}),b("Compromisso atualizado."),k(null),E()}catch{b("Falha ao atualizar.")}}},re=()=>{k(null)},se=async t=>{b(""),J(t),D(null);try{await pe(t,{status:"CANCELLED"}),b("Agendamento cancelado."),E()}catch{b("Falha ao cancelar agendamento.")}finally{J(null)}};r.useEffect(()=>{N&&$e().then(t=>{var a;K(t.contracts||[]),(a=t.contracts)!=null&&a.length&&!v&&F(t.contracts[0].id)}).catch(()=>K([]))},[N]);const De=()=>{var t;S(""),F(((t=R[0])==null?void 0:t.id)||""),y([{appointment_date:"",start_time:"09:00"}]),P(!0)},Ee=()=>{y(t=>[...t,{appointment_date:"",start_time:"09:00"}])},_e=t=>{y(a=>a.filter((n,u)=>u!==t))},Ae=async()=>{if(!v)return;const t=ee.filter(a=>a.appointment_date&&a.start_time);if(t.length===0){S("Adicione ao menos uma data e horário.");return}ae(!0),S("");try{const a=await Ue(v,t);S(a.created?`${a.created} agendamento(s) criado(s).`:"Nenhum agendamento criado."),a.created&&(P(!1),E())}catch{S("Falha ao criar agendamentos.")}finally{ae(!1)}},ke=()=>T(j(M(new Date(f+"T12:00:00"),-7))),Le=()=>T(j(M(new Date(f+"T12:00:00"),7))),we=()=>T(j(fe(new Date))),$=Array.from({length:7},(t,a)=>M(new Date(f+"T12:00:00"),a)),ie=Xe-Y,Pe=ie*h,Re=$.map(t=>{const a=j(t);return je.filter(n=>n.appointment_date===a&&n.status!=="CANCELLED")});if((o==null?void 0:o.role)==="SUPER_ADMIN"&&!l)return e.jsx(Be,{to:"/backoffice",replace:!0});if((o==null?void 0:o.role)!=="PROFESSIONAL"&&(o==null?void 0:o.role)!=="SUPER_ADMIN")return e.jsx(me,{children:e.jsx(c,{children:"Apenas profissionais podem acessar a agenda."})});const Ie=`${Ce(f)} – ${Ce(W)}`,Me=t=>t==="CONFIRMED"?"success.light":t==="COMPLETED"?"info.light":"warning.light";return e.jsxs(me,{children:[e.jsxs(i,{sx:{display:"flex",flexWrap:"wrap",alignItems:"center",gap:1,mb:2},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.25},children:[e.jsx(B,{onClick:ke,"aria-label":"Semana anterior",size:"small",children:e.jsx(He,{})}),e.jsx(B,{onClick:Le,"aria-label":"Próxima semana",size:"small",children:e.jsx(Ye,{})}),e.jsx(d,{variant:"outlined",size:"small",onClick:we,sx:{ml:.5},children:"Hoje"})]}),e.jsx(c,{variant:"h5",fontWeight:600,sx:{flex:1},children:Ie}),e.jsx(d,{variant:"contained",onClick:De,sx:{bgcolor:m,"&:hover":{bgcolor:m,opacity:.9}},children:"Criar agendamentos"})]}),z&&e.jsx(c,{sx:{mb:1,color:z.includes("Falha")?"error.main":"success.main",fontSize:14},children:z}),ve?e.jsx(c,{color:"text.secondary",children:"Carregando..."}):e.jsxs(de,{variant:"outlined",sx:{display:"grid",gridTemplateColumns:"48px repeat(7, minmax(0, 1fr))",gridTemplateRows:`auto ${Pe}px`,overflow:"hidden",minHeight:400},children:[e.jsx(i,{sx:{gridColumn:1,gridRow:1,borderRight:1,borderBottom:1,borderColor:"divider",bgcolor:"grey.50"}}),$.map((t,a)=>e.jsxs(i,{sx:{gridColumn:a+2,gridRow:1,py:.5,textAlign:"center",borderBottom:1,borderRight:a<6?1:0,borderColor:"divider",bgcolor:"grey.50",fontSize:13,fontWeight:500},children:[e.jsx(c,{variant:"caption",color:"text.secondary",children:Ve[t.getDay()]}),e.jsx(c,{variant:"body2",children:t.getDate()})]},a)),e.jsx(i,{sx:{gridColumn:1,gridRow:2,display:"flex",flexDirection:"column",borderRight:1,borderColor:"divider",bgcolor:"grey.50"},children:Array.from({length:ie},(t,a)=>e.jsxs(i,{sx:{height:h,pr:.35,textAlign:"right",fontSize:11,color:"text.secondary",lineHeight:`${h}px`},children:[String(Y+a).padStart(2,"0"),":00"]},a))}),$.map((t,a)=>e.jsx(i,{role:"gridcell",sx:{gridColumn:a+2,gridRow:2,position:"relative",borderRight:a<6?1:0,borderColor:"divider",background:`repeating-linear-gradient( transparent, transparent ${h-1}px, ${s.palette.grey[200]} ${h-1}px, ${s.palette.grey[200]} ${h}px)`},onClick:()=>D(null),children:Re[a].map(n=>{const u=be(n.start_time),g=be(n.end_time),_=Y*60,Te=Math.max(0,(u-_)/60*h),ze=Math.max(20,(g-u)/60*h),ce=ye===n.id;return e.jsxs(de,{elevation:0,sx:p=>({position:"absolute",left:4,right:4,top:Te+2,height:ze-4,bgcolor:n.status==="COMPLETED"?H(p.palette.info.main,.14):n.status==="CANCELLED"?H(p.palette.error.main,.1):H(p.palette.primary.main,.14),border:"1px solid",borderColor:n.status==="CANCELLED"?"error.light":"primary.light",borderRadius:.75,overflow:"hidden",cursor:"pointer",fontSize:12}),onClick:p=>{p.stopPropagation(),D(ce?null:n.id)},onDoubleClick:p=>{p.stopPropagation(),D(null),oe(n)},children:[e.jsxs(i,{sx:{px:.75,py:.25,fontWeight:500},children:[n.start_time," – ",n.end_time]}),e.jsx(i,{sx:{px:.75,pb:.5,color:"text.secondary",fontSize:11},children:n.patient_name||`Paciente ${n.patient_id.slice(0,8)}…`}),e.jsx(i,{sx:{px:.75,pb:.5},children:e.jsx(c,{component:"span",variant:"caption",sx:{px:.35,py:.1,borderRadius:.5,bgcolor:Me(n.status)},children:n.status})}),ce&&e.jsxs(i,{sx:{p:.5,borderTop:1,borderColor:"divider",display:"flex",gap:.25,flexWrap:"wrap"},onClick:p=>p.stopPropagation(),children:[e.jsx(d,{size:"small",variant:"contained",onClick:()=>oe(n),sx:{bgcolor:m,"&:hover":{bgcolor:m,opacity:.9},minWidth:"auto",py:.25,px:.5},children:"Alterar"}),n.status!=="CANCELLED"&&n.status!=="COMPLETED"&&e.jsx(d,{size:"small",variant:"outlined",color:"error",onClick:()=>se(n.id),disabled:w===n.id,sx:{minWidth:"auto",py:.25,px:.5},children:w===n.id?"...":"Cancelar"})]})]},n.id)})},a))]}),e.jsx(ue,{open:!!x,onClose:re,title:"Editar compromisso",actions:e.jsxs(e.Fragment,{children:[e.jsx(d,{onClick:Se,variant:"contained",sx:{bgcolor:m,"&:hover":{bgcolor:m,opacity:.9}},children:"Salvar"}),e.jsx(d,{onClick:re,color:"inherit",children:"Fechar"}),L!=="CANCELLED"&&L!=="COMPLETED"&&x&&e.jsx(d,{variant:"outlined",color:"error",onClick:async()=>{await se(x),k(null)},disabled:w===x,children:w===x?"Cancelando...":"Cancelar agendamento"})]}),children:e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:1,mb:2},children:[e.jsx(I,{type:"date",label:"Data",size:"small",fullWidth:!0,value:V,onChange:t=>X(t.target.value),InputLabelProps:{shrink:!0}}),e.jsx(I,{type:"time",label:"Horário",size:"small",fullWidth:!0,value:Z,onChange:t=>q(t.target.value),InputLabelProps:{shrink:!0}}),e.jsxs(he,{fullWidth:!0,size:"small",children:[e.jsx(xe,{children:"Status"}),e.jsxs(ge,{value:L,label:"Status",onChange:t=>G(t.target.value),children:[e.jsx(A,{value:"CONFIRMED",children:"Confirmado"}),e.jsx(A,{value:"CANCELLED",children:"Cancelado"}),e.jsx(A,{value:"COMPLETED",children:"Realizado"})]})]})]})}),e.jsxs(ue,{open:N,onClose:()=>P(!1),title:"Criar agendamentos",actions:e.jsxs(e.Fragment,{children:[e.jsx(d,{onClick:()=>P(!1),color:"inherit",children:"Fechar"}),e.jsx(d,{variant:"contained",onClick:Ae,disabled:te||!v||R.length===0,sx:{bgcolor:m,"&:hover":{bgcolor:m,opacity:.9}},children:te?"Criando...":"Criar agendamentos"})]}),children:[e.jsx(c,{variant:"body2",color:"text.secondary",sx:{mb:1},children:"Vincule os novos compromissos a um contrato assinado."}),e.jsxs(he,{fullWidth:!0,size:"small",sx:{mb:2},children:[e.jsx(xe,{children:"Contrato"}),e.jsxs(ge,{value:v,label:"Contrato",onChange:t=>F(t.target.value),children:[R.length===0&&e.jsx(A,{value:"",children:"Nenhum contrato assinado"}),R.map(t=>e.jsxs(A,{value:t.id,children:[t.patient_name," – ",t.template_name]},t.id))]})]}),e.jsx(c,{variant:"subtitle2",sx:{mb:.5},children:"Data e horário"}),ee.map((t,a)=>e.jsxs(i,{sx:{display:"flex",gap:.5,alignItems:"center",mb:.5},children:[e.jsx(I,{type:"date",size:"small",value:t.appointment_date,onChange:n=>y(u=>u.map((g,_)=>_===a?{...g,appointment_date:n.target.value}:g)),InputLabelProps:{shrink:!0},sx:{flex:1}}),e.jsx(I,{type:"time",size:"small",value:t.start_time,onChange:n=>y(u=>u.map((g,_)=>_===a?{...g,start_time:n.target.value}:g)),InputLabelProps:{shrink:!0}}),e.jsx(B,{size:"small",color:"error",onClick:()=>_e(a),"aria-label":"Remover",children:e.jsx(Qe,{fontSize:"small"})})]},a)),e.jsx(d,{size:"small",variant:"outlined",onClick:Ee,sx:{mb:1},children:"+ Adicionar horário"}),O&&e.jsx(c,{sx:{color:O.includes("Falha")?"error.main":"success.main",fontSize:14},children:O})]})]})}export{at as Agenda};
