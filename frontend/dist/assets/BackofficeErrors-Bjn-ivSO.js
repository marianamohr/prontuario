import{e as _,r as i,a1 as C,j as e,T as m,B as y,V as g,P as O,L as P}from"./index-DJlnvih6.js";import{P as I}from"./PageContainer-DrcGApUY.js";import{T as k}from"./TextField-CttgYVuf.js";import{F as q,I as N,S as W}from"./Select-cu5oWY5i.js";import{B as E}from"./Button-6qkZ5rwi.js";import{A as B}from"./Alert-CVqmUb3o.js";import{T as H,a as A,b as D,c as j,d as o,e as L}from"./TableRow-Bh5fPPOD.js";import{C as F}from"./Chip-D7mbk4PO.js";function z(a){const t=String(a||"").trim();if(!t)return"Erro sem mensagem.";if(t.startsWith("{")&&t.endsWith("}"))try{const r=JSON.parse(t);if(r!=null&&r.detail&&(r!=null&&r.error))return`${String(r.error)} (${String(r.detail)})`;if(r!=null&&r.error)return String(r.error)}catch{}return t}function w(a){var l;const t=String(a.kind||"").toUpperCase(),r=a.http_method?String(a.http_method):"",c=a.path?String(a.path):"",n=z(a.message);if(t==="FETCH_ERROR")return`Falha de rede ao chamar ${r||"HTTP"} ${c||"(endpoint desconhecido)"}: ${n}`;if(t==="HTTP_ERROR"){const h=((l=a.metadata)==null?void 0:l.status)??void 0;return`${h?`HTTP ${h}`:"HTTP error"} em ${r||"HTTP"} ${c||"(endpoint desconhecido)"}: ${n}`}return t==="JSON_PARSE_ERROR"?`Resposta inválida (JSON) em ${r||"HTTP"} ${c||"(endpoint desconhecido)"}: ${n}`:t==="REACT_ERROR_BOUNDARY"?`Erro de renderização (React): ${n}`:t==="WINDOW_ERROR"?`Erro global do navegador: ${n}`:t==="UNHANDLED_REJECTION"?`Promise rejeitada sem tratamento: ${n}`:a.pg_message?`Erro no banco: ${String(a.pg_message)}`:`${t||"Erro"}: ${n}`}function X(){const[a]=_(),t=a.get("request_id")||"",[r,c]=i.useState([]),[n,l]=i.useState(!1),[h,u]=i.useState(""),[R,T]=i.useState(0),[x,S]=i.useState(t),[f,b]=i.useState("");i.useEffect(()=>{S(t)},[t]);const $=i.useMemo(()=>r.length>0&&!n,[r.length,n]),p=i.useCallback(s=>{l(!0),u("");const v=s?0:R;C({limit:50,offset:v,request_id:x.trim()||void 0,severity:f||void 0}).then(d=>{c(s?d.items:[...r,...d.items]),T(v+d.items.length)}).catch(d=>u((d==null?void 0:d.message)||"Falha ao carregar erros.")).finally(()=>l(!1))},[R,x,f,r]);return i.useEffect(()=>{p(!0)},[]),e.jsxs(I,{children:[e.jsx(m,{variant:"h4",sx:{mb:1.5},children:"Erros (bugs)"}),e.jsx(m,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Lista de erros do frontend e backend (sem PII). Clique no Request ID para ver a Auditoria correlacionada."}),e.jsxs(y,{sx:{display:"flex",gap:1,flexWrap:"wrap",mb:2},children:[e.jsx(k,{label:"Request ID (opcional)",value:x,onChange:s=>S(s.target.value),size:"small",sx:{minWidth:280}}),e.jsxs(q,{size:"small",sx:{minWidth:180},children:[e.jsx(N,{children:"Severidade"}),e.jsxs(W,{value:f,label:"Severidade",onChange:s=>b(String(s.target.value)),children:[e.jsx(g,{value:"",children:"Todas"}),e.jsx(g,{value:"WARN",children:"WARN"}),e.jsx(g,{value:"ERROR",children:"ERROR"})]})]}),e.jsx(E,{variant:"contained",onClick:()=>p(!0),disabled:n,children:n?"Carregando...":"Buscar"}),e.jsx(E,{variant:"outlined",onClick:()=>p(!1),disabled:!$,children:"Carregar mais"})]}),h&&e.jsx(B,{severity:"error",sx:{mb:2},children:h}),e.jsx(H,{component:O,variant:"outlined",children:e.jsxs(A,{size:"small",children:[e.jsx(D,{children:e.jsxs(j,{children:[e.jsx(o,{children:"Data/hora"}),e.jsx(o,{children:"Sev"}),e.jsx(o,{children:"Origem"}),e.jsx(o,{children:"Descrição"}),e.jsx(o,{children:"Request"})]})}),e.jsxs(L,{children:[r.map(s=>e.jsxs(j,{hover:!0,children:[e.jsx(o,{sx:{whiteSpace:"nowrap"},children:new Date(s.created_at).toLocaleString("pt-BR")}),e.jsx(o,{children:e.jsx(F,{size:"small",label:s.severity})}),e.jsx(o,{children:s.source}),e.jsxs(o,{sx:{maxWidth:760},children:[e.jsx(m,{variant:"body2",sx:{fontWeight:600},children:w(s)}),e.jsxs(m,{variant:"caption",color:"text.secondary",children:[s.http_method&&s.path?`${s.http_method} ${s.path}`:"",s.action_name?` • ação: ${s.action_name}`:"",s.kind?` • kind: ${s.kind}`:""]})]}),e.jsx(o,{sx:{fontFamily:"monospace",fontSize:12},children:s.request_id?e.jsx(P,{to:`/backoffice/audit?request_id=${encodeURIComponent(s.request_id)}`,style:{color:"inherit"},children:s.request_id}):"—"})]},s.id)),r.length===0&&e.jsx(j,{children:e.jsx(o,{colSpan:5,children:e.jsx(m,{color:"text.secondary",children:"Nenhum erro encontrado."})})})]})]})})]})}export{X as BackofficeErrors};
