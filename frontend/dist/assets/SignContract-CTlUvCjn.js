import{e as I,r as l,j as e,B as a,T as r,V as E,a4 as H,a5 as w}from"./index-DJlnvih6.js";import{F as B,I as $,S as M}from"./Select-cu5oWY5i.js";import{F as R}from"./FormControlLabel-BcClaYQT.js";import{C as L}from"./Checkbox-Bncplgv-.js";import{B as P}from"./Button-6qkZ5rwi.js";const v="".replace(/\/$/,""),z=[{value:"cursive",label:"Cursiva"},{value:"brush",label:"Brush Script"},{value:"dancing",label:"Dancing Script"}];function O(c){switch(c){case"brush":return"'Brush Script MT', cursive";case"dancing":return"'Dancing Script', cursive";case"cursive":default:return"'Segoe Script', 'Dancing Script', cursive"}}function U(c){const o=String(c.getDate()).padStart(2,"0"),n=String(c.getMonth()+1).padStart(2,"0"),x=c.getFullYear();return`${o}/${n}/${x}`}function V(c,o){const n=c.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");return`<span style="font-family: ${O(o)}; font-size: 1.25em;">${n}</span>`}function K(){var S;const[c]=I(),o=c.get("token")||"",[n,x]=l.useState(null),[h,_]=l.useState(!1),[p,A]=l.useState("cursive"),[C,j]=l.useState(!!o),[y,b]=l.useState(!1),[f,d]=l.useState(""),[T,k]=l.useState(!1);l.useEffect(()=>{if(!o){d("Token não informado."),j(!1);return}fetch(`${v}/api/contracts/by-token?token=${encodeURIComponent(o)}`).then(t=>{if(!t.ok)throw new Error("Token inválido ou expirado.");return t.json()}).then(t=>{if(!t||typeof t!="object"||Array.isArray(t)){d("Resposta inválida do servidor.");return}const s=t,i=typeof s.contract_id=="string"?s.contract_id:"",u=typeof s.body_html=="string"?s.body_html:"";if(!i||u===void 0){d("Dados do contrato incompletos.");return}x({contract_id:i,patient_name:typeof s.patient_name=="string"?s.patient_name:"",guardian_name:typeof s.guardian_name=="string"?s.guardian_name:"",body_html:u,signer_relation:typeof s.signer_relation=="string"?s.signer_relation:"",signer_is_patient:s.signer_is_patient===!0,status:typeof s.status=="string"?s.status:"",clinic_name:typeof s.clinic_name=="string"?s.clinic_name:""})}).catch(()=>d("Token inválido ou expirado.")).finally(()=>j(!1))},[o]);const N=l.useMemo(()=>{let t=(n==null?void 0:n.body_html)??"";const s=(n==null?void 0:n.guardian_name)??"";if(!t)return t;if(s){const u=V(s,p);t=t.replace(/\[ASSINATURA_RESPONSAVEL\]/g,u)}const i=U(new Date);return t.includes("[DATA]")&&(t=t.replace(/\[DATA\]/g,i)),t},[n==null?void 0:n.body_html,n==null?void 0:n.guardian_name,p]),D=async()=>{if(!h||!o)return;b(!0),d("");const t={"Content-Type":"application/json"},s=localStorage.getItem("token");s&&(t.Authorization=`Bearer ${s}`);try{const i=await fetch(`${v}/api/contracts/sign`,{method:"POST",headers:t,body:JSON.stringify({token:o,accepted_terms:!0,signature_font:p})});if(!i.ok){const u=await i.text();throw new Error(u||"Falha ao assinar")}k(!0)}catch(i){d(i instanceof Error?i.message:"Falha ao assinar.")}finally{b(!1)}},m="sign-contract-page",F=((S=n==null?void 0:n.clinic_name)==null?void 0:S.trim())||"Contrato",g=e.jsx(H,{position:"static",elevation:0,sx:{bgcolor:"background.paper",color:"text.primary",borderBottom:1,borderColor:"divider"},children:e.jsx(w,{children:e.jsx(r,{variant:"h6",component:"h1",children:F})})});return C?e.jsxs(a,{className:m,sx:{minHeight:"100vh",display:"flex",flexDirection:"column"},children:[g,e.jsx(a,{className:"sign-contract-loading",sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",p:2},children:e.jsx(r,{color:"text.secondary",children:"Carregando contrato..."})})]}):f&&!n?e.jsxs(a,{className:m,sx:{minHeight:"100vh",display:"flex",flexDirection:"column"},children:[g,e.jsx(a,{className:"sign-contract-error-only",sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",p:2},children:e.jsx(r,{color:"error",children:f})})]}):T?e.jsxs(a,{className:m,sx:{minHeight:"100vh",display:"flex",flexDirection:"column"},children:[g,e.jsx(a,{className:"sign-contract-success",sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",p:2},children:e.jsxs(a,{children:[e.jsx(r,{variant:"h5",component:"h2",sx:{mb:.5},children:"Contrato assinado com sucesso"}),e.jsx(r,{color:"text.secondary",children:"Uma cópia foi enviada ao seu e-mail."})]})})]}):n?e.jsxs(a,{className:m,sx:{minHeight:"100vh",display:"flex",flexDirection:"column"},children:[g,e.jsxs(a,{sx:{flex:1,width:"100%",maxWidth:"100%",boxSizing:"border-box",p:2},children:[e.jsx(r,{variant:"h4",sx:{mb:2},children:"Assinar contrato"}),e.jsxs(a,{sx:{mb:2,p:1.5,bgcolor:"grey.50",borderRadius:1},children:[e.jsxs(r,{children:[e.jsx("strong",{children:"Paciente:"})," ",(n==null?void 0:n.patient_name)??"—"]}),e.jsxs(r,{children:[e.jsx("strong",{children:"Responsável/Assinante:"})," ",(n==null?void 0:n.guardian_name)??"—"]}),e.jsxs(r,{children:[e.jsx("strong",{children:"Relação:"})," ",(n==null?void 0:n.signer_relation)??"—"]})]}),e.jsxs(B,{fullWidth:!0,size:"small",sx:{mb:1},children:[e.jsx($,{children:"Fonte da sua assinatura"}),e.jsx(M,{value:p,label:"Fonte da sua assinatura",onChange:t=>A(t.target.value),children:z.map(t=>e.jsx(E,{value:t.value,children:t.label},t.value))})]}),e.jsx(r,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Sua assinatura aparecerá no contrato com a fonte escolhida."}),e.jsx(a,{className:"sign-contract-preview",dangerouslySetInnerHTML:{__html:N},sx:{mb:2}}),e.jsx(R,{control:e.jsx(L,{checked:h,onChange:t=>_(t.target.checked)}),label:"Li e concordo com os termos do contrato.",sx:{display:"block",mb:1}}),f&&e.jsx(r,{color:"error",sx:{mb:2},children:f}),e.jsx(P,{variant:"contained",disabled:!h||y,onClick:D,sx:{bgcolor:h&&!y?void 0:"grey.400"},children:y?"Assinando...":"Assinar"})]})]}):e.jsxs(a,{className:m,sx:{minHeight:"100vh",display:"flex",flexDirection:"column"},children:[g,e.jsx(a,{className:"sign-contract-error-only",sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",p:2},children:e.jsx(r,{color:"text.secondary",children:"Não foi possível carregar o contrato. Verifique o link ou tente novamente."})})]})}export{K as SignContract};
